version: 0.2

env:
  variables:
     KUBECONFIG: deploy/kubeconfig
phases:
  install:
    commands:
      - . deploy/bin/init-deploy-env
      - /bin/bash -xeu deploy/bin/credstash-get-deploy-secrets
      - env
  pre_build:
    commands:
      - /bin/bash -xeu deploy/bin/start-docker-dind
      - sleep 1
      - /bin/bash -xu deploy/bin/restore-container-build-cache
  build:
    commands:
      - /bin/bash -xeu deploy/bin/build-and-push-docker-image
      - /bin/bash -xeu deploy/bin/deploy-chart
      - /bin/bash -xeu deploy/bin/notify-build-success
  post_build:
    commands:
      - /bin/bash -xu deploy/bin/save-container-build-cache
cache:
  paths:
    - container-build-cache.tar.gz
