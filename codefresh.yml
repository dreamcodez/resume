version: '1.0'
steps:
  build:
    type: build
    dockerfile: Dockerfile
    image_name: dreamcodez/resume
    tag: ${{CF_SHORT_REVISION}}
  push:
    type: push
    candidate: ${{build}}
    tag: ${{CF_SHORT_REVISION}}
    registry: quay
    #when:
    #  branch:
    #    only: 
    #      - /^master$/
  deploy-to-kubernetes:
    image: codefresh/cf-deploy-kubernetes
    working-directory: ${{initial-clone}}
    tag: ${{CF_SHORT_REVISION}}
    commands:
      - 'echo -n $KUBECREDENTIALSB64 | base64 -d | tar -xvz'
      - 'kubectl apply -f deployment.yml'
      - "kubectl delete pod -l 'app=resume'"
    environment:
      - KUBECONFIG=kubeconfig
